<!doctype html>
<html lang="en">
    <head>
        <title>{{ hostname.capitalize() }} live monitoring</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="{{ url_for('v1.static', filename='design.css') }}"/>
        <link rel="stylesheet" href="{{ url_for('v1.static', filename='select2/select2.css') }}"/>
        <link rel="icon" type="image/png" href="{{ url_for('v1.static', filename='favicon.png') }}" />
        <script src="{{ url_for('v1.static', filename='jquery-1.9.1.min.js') }}"></script>
        <script src="{{ url_for('v1.static', filename='jquery.cookie-1.4.0.min.js') }}"></script>
        <script src="{{ url_for('v1.static', filename='jquery.numeric-1.3.1.min.js') }}"></script>
        <script src="{{ url_for('v1.static', filename='select2/select2.min.js') }}"></script>
        <script type="text/javascript">
        // <![CDATA[
            function reloadImage(img) {
                var src = img.attr('src');
                src = src.split('#')[0];
                src += '#' + Date.now();
                img.attr('src', src);
            }

            function reloadAllImages() {
                $('.graph').each(function() {
                    reloadImage($(this));
                });
            }

            function selectJobId() {
                deselectAll();
                job = $('#job-field').val();
                if(!job) {
                    return;
                }
                $('#loading-div-background').show();
                $.ajax({
                    url: '/nodes/' + job + '/',
                    dataType: 'json',
                    success: function(data) {
                        var items = data.nodes;
                        if(items.length === 0) {
                            alert('No hosts found');
                        }
                        var selected = [];
                        $.each(items, function(i, e) {
                            e = e.split('.');
                            e = e[1] + '.' + e[0];
                            if(probeInSelect(e)) {
                                selected[selected.length] = e;
                                $('select').trigger({
                                    type: 'select2-selecting',
                                    val: e
                                });
                            }
                            else
                            {
                                $('#not-found').append('<li>' + e + ' is not monitored</li>');
                                $('#probes-not-found').show();
                            }
                        })
                        $('select').select2('val', selected);
                        $('#loading-div-background').hide();
                    },
                    timeout: 10000,
                    error: function(jqXHR, status, errorThrown) {
                        alert('Timeout');
                        $('#loading-div-background').hide();
                    }
                });
            }

            function selectAll() {
                deselectAll();
                var selected = [];
                $('select option').each(function(i, e) {
                    selected[selected.length] = $(e).attr('value');
                    $('select').trigger({
                        type: 'select2-selecting',
                        val: $(e).attr('value')
                    });
                });
                $('select').select2('val', selected);
                reloadAllImages();
                $("#zip").text('Download all probes RRD');
            }

            function deselectAll() {
                $('select').each(function () {
                    $(this).select2('val', '');
                });
                var selected = [];
                $('select option').each(function(i, e) {
                    selected[selected.length] = $(e).attr('value');
                    $('select').trigger({
                        type: 'select2-removing',
                        val: $(e).attr('value')
                    });
                });
                $('#probes-not-found').hide();
                $('#not-found').empty();
                $("#zip").text('Download all probes RRD');
            }

            function probeInSelect(probe) {
                var found = false;
                $('select option').each(function(i, e) {
                    if(probe == $(e).attr('value')) {
                        found = true;
                    }
                });
                return found;
            }

            $(function(){
                $("#zip").click(function(){
                    $(this).attr("href", "/zip/?probes=" + $('select').select2('val'));
                });
            });

            $(document).ready(function () {
                setInterval('reloadAllImages()', {{ refresh*1000 }});

                $('#job-field').numeric({decimal: false, negative: false});

                $('#loading-div-background').css({opacity: 0.75});

                // Init select probe list
                var cookie = $.cookie('probes');
                if(!cookie) {
                    var probes = [];
                } else {
                    var probes = JSON.parse(cookie);
                }
                $('select').select2({
                    placeholder: 'Select probes'
                });
                $('select').select2('val', probes);

                // Event handler for adding a probe
                $(document.body).on('select2-selecting', 'select', function(e) {
                    var probe = '<a href="/probe/' + e.val + '/' + '"><img class="graph" id="' + e.val + '" src="/graph/{{ scale }}/' + e.val + '/" alt="Graph ' + e.val + '"/></a>';
                    $('#probes').append(probe);
                    $("#zip").text('Download selected probes RRD');
                    reloadAllImages();
                });

                // Event handler for deleting a probe
                $(document.body).on('select2-removing', 'select', function(e) {
                    $('#' + e.val.replace(/\./g, '\\.')).parent().remove();
                    if($('select').select2('val') == '') {
                        $("#zip").text('Download all probes RRD');
                    } else {
                        $("#zip").text('Download selected probes RRD');
                    }
                });

                // Bind buttons to event handlers
                $('#job-button').click(selectJobId);
                $('#select-all').click(selectAll);
                $('#deselect-all').click(deselectAll);

                // Display the graph for each preselected probes
                $.each(probes, function(index, value) {
                    $('select').trigger({
                        type: 'select2-selecting',
                        val: value
                    });
                });

                {% if view == 'scale' %}
                    // Set a cookie storing the probe list
                    $(window).unload(function() {
                        var value = $('select').val();
                        if(value == null) {
                            $.removeCookie('probes', {path: '/'});
                        } else {
                            $.cookie('probes', JSON.stringify(value), {path: '/'});
                        }
                    });
                {% endif %}
            });
        // ]]>
        </script>
    </head>
    <body>
        <div id="header"><h1>{{ hostname.capitalize() }} energy monitoring</h1></div>
        <!-- Horizontal menu bar -->
        <div class="menu">
            <ul>
                {% for label in scales %}
                    {% if label == scale %}
                        <li><a class="active" href="/last/{{ label }}/">{{ label }}</a></li>
                    {% else %}
                        <li><a href="/last/{{ label }}/">{{ label }}</a></li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div id="inner">
            <!-- Scale view (all probes for one scale) -->
            {% if view == 'scale' %}
                {% if probes|count > 0 %}
                    <h2>Summary</h2>
                    <!-- Display summary graph -->
                    <img class="graph" id="summary" src="/graph/{{ scale }}/" alt="Summary graph"/>
                    <h2>Details</h2>
                    <!-- Display all probe graphs -->
                    <select multiple>
                    {% for probe in probes %}
                        <option value="{{ probe }}">{{ probe }}</option>
                    {% endfor %}
                    </select>
                    <input type="text" id="job-field"/><button type="button" id="job-button">Job</button>
                    <button type="button" id="select-all">All</button>
                    <button type="button" id="deselect-all">Clear</button>
                    <a style="float:right; margin-top:10px" id="zip" href="/zip/">Download all probes RRD</a>
                    <div id="probes"></div>
                    <div id="probes-not-found" style="display:none">Probes not found:
                        <ul id="not-found"></ul>
                    </div>
                {% else %}
                    <p>No probes found.</p>
                {% endif %}

            <!-- Probe view (all scales for one probe) -->
            {% elif view == 'probe' %}
                <h2>{{ probe }} <a style="float:right" id="zip" href="/rrd/{{ probe }}/">Download RRD</a></h2>
                {% for scale in scales %}
                    <img class="graph" src="/graph/{{ scale }}/{{ probe }}/" alt="Graph {{ probe }}"/>
                {% endfor %}
            {% endif %}
        </div>
        <div id="loading-div-background">
            <div id="loading-div">
                <h2>Please wait...</h2>
            </div>
        </div>
    </body>
</html>
